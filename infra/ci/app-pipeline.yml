resource_types:
- name: ecr-tag-resource
  type: docker-image
  source:
    repository: petegoo/concourse-ecr-tag-resource
    tag: latest

resources:
- name: ecr
  type: docker-image
  source:
    aws_access_key_id: ((aws-token))
    aws_secret_access_key: ((aws-secret))
    repository: ((aws-repo))

- name: git-repo
  type: git
  source:
    uri: https://github.com/GevorgTonoyan/jokes-api.git
    branch: run-app
    username: ((github-username))
    password: ((github-access-token))
- name: ecr-tag
  type: ecr-tag-resource
  source:
    repository: ((aws-repo))

jobs:
- name: release-and-deploy
  plan:
  - get: git-repo
    trigger: true
  - put: ecr-tag
    params:
      build: ./git-repo/api/
      new_tag: latest

# - name: run-api
#   plan: 
#     passed: 
#     - build-and-push
#     - get: git-repo
#       trigger: true
#     - task: run-flask
#       privileged: true
#       file: git-repo/infra/ci/tasks/run-api.yml
