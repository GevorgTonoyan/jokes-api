resources:
- name: source
  type: git
  icon: github
  source:
    uri: git@github.com:GevorgTonoyan/jokes-api.git
    branch: run-app
    username: GevorgTonoyan
    private_key: ((key))

- name: trusted-image
  type: registry-image
  source:
    repository: https://hub.docker.com/repository/docker/gevi/myhub
    username: ((dockerhub_user))
    password: ((dockerhub_password))

- name: image
  type: docker-image
  source:
    username: ((dockerhub_user))
    password: ((dockerhub_password))
    tag: latest
    repository: ((image-repo-name))/jokesapi

jobs:
- name: build-and-push
  plan: 
    - get: source
      trigger: true
    - task: build-image
      privileged: true
      file: source/infra/ci/tasks/build-api.yml
      params:
        DOCKERFILE: source/api/Dockerfile
    - put: image
      params: {gevi:jokesapi/jokesapi.tar}

# - name: run-api
#   plan: 
#     passed: 
#     - build-and-push
#     - get: source
#       trigger: true
#     - task: run-flask
#       privileged: true
#       file: source/infra/ci/tasks/run-api.yml
